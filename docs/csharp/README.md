# RPG Overhaul C# Implementation

This C# project provides the core game logic patches required to implement the full RPG Overhaul weapon system in 7 Days to Die.

## Features Implemented

### ✅ Elemental Damage System

- **Fire, Ice, Electric, Poison, Radiation, Explosive, Bleeding, Void** elemental types
- **Damage over time (DoT)** effects with configurable duration and tick rates
- **Elemental spread mechanics** - effects can jump to nearby enemies
- **Visual particle effects** for each elemental type

### ✅ Affixes System

- **Prefix/Suffix/Implicit/Unique affixes** with stat modifications
- **Percentage and flat bonuses** (base_add, perc_add, multiply operations)
- **Tier and level requirements** for affix availability
- **Real-time stat calculation** when equipping items

### ✅ Weapon Parts System

- **8 part slots**: Barrel, Trigger, Stock, Magazine, Scope, Grip, Muzzle, Underbarrel
- **4 tiers**: Basic, Advanced, Master, Legendary
- **Synergy bonuses** for matching part sets (3+ parts of same tier)
- **Special effects** (Silent, Stability, Fast Action, High Capacity)

### ✅ Mastery System

- **Per-weapon-type mastery** tracking (pistol, rifle, shotgun, etc.)
- **Experience-based progression** with level-ups
- **Stat bonuses** that scale with mastery level
- **Persistent data storage** across game sessions

### ✅ Triggered Effects System

- **onFire, onHit, onKill, onHeadshot, onCritical** triggers
- **Instant Kill, Heal, Explosion, Chain Lightning** effects
- **Cooldown management** to prevent spam
- **Probability-based activation**

## Architecture

### Core Systems

```
Main.cs                 - Mod entry point and initialization
HarmonyPatches.cs       - Core game function patches
ElementalDamageSystem.cs - Elemental damage implementation
AffixSystem.cs          - Affix stat modifications
WeaponPartsSystem.cs    - Weapon parts and synergies
MasterySystem.cs        - Player mastery progression
TriggeredEffectsSystem.cs - Triggered effect handling
```

### Harmony Patches Applied

- `ItemActionAttack.Hit` - Elemental damage application
- `EntityAlive.DamageEntity` - Damage processing
- `ItemValue.Clone` - Stat modification application
- `ItemActionRanged.Fire` - Trigger activation
- `EntityAlive.OnEntityDeath` - Kill triggers

## Dependencies

- **Lib.Harmony 2.2.2** - Runtime patching library
- **7D2D Assembly-CSharp.dll** - Game core assembly
- **UnityEngine assemblies** - Unity game engine

## Build Process

### Prerequisites

1. **Visual Studio 2019+** or **.NET SDK 4.8**
2. **7 Days to Die game installation** (for reference assemblies)
3. **NuGet package manager**

### Setup Steps

1. **Copy Game Assemblies**:

   ```batch
   # Copy from your 7D2D installation
   copy "C:\Program Files (x86)\Steam\steamapps\common\7 Days To Die\7DaysToDie_Data\Managed\Assembly-CSharp.dll" lib/
   copy "C:\Program Files (x86)\Steam\steamapps\common\7 Days To Die\7DaysToDie_Data\Managed\UnityEngine.dll" lib/
   ```

2. **Build the Mod**:

   ```batch
   # Run the build script
   build.bat
   ```

3. **Deploy to Game**:
   - Copy `RPGOverhaul.dll` to your mod directory
   - Ensure Harmony is installed in the game

## Integration with XML Generation

This C# mod works alongside the TypeScript XML generation system:

1. **TypeScript generates** the weapon/item data with custom properties
2. **C# mod reads** these properties and applies the actual game effects
3. **Harmony patches** intercept vanilla game functions to add RPG features

### Property Mapping Examples

```xml
<!-- Generated by TypeScript -->
<item name="Legendary_Plasma_Rifle">
  <property name="ElementalDamageType" value="plasma" />
  <property name="ElementalDamage" value="25.5" />
  <property name="Prefixes" value="Devastating,Laser-Guided" />
  <property name="Part0_Slot" value="barrel" />
  <property name="Part0_Name" value="Plasma Barrel" />
  <property name="TriggeredEffect0_Trigger" value="onKill" />
  <property name="TriggeredEffect0_Effect" value="explosion" />
</item>
```

The C# mod reads these properties and applies:

- Plasma elemental damage effects
- "Devastating" (+35-55% damage) and "Laser-Guided" (+30-50% accuracy) affixes
- Plasma Barrel part modifiers
- Explosion effect on kill (20% chance)

## Performance Considerations

### Memory Management

- **Object pooling** for frequently created effect objects
- **Lazy loading** of weapon data
- **Dictionary caching** for frequently accessed data

### Patch Efficiency

- **Minimal patch count** - only essential functions patched
- **Early returns** for non-RPG items
- **Conditional execution** based on item properties

### Thread Safety

- **Main thread execution** for Unity operations
- **Atomic operations** for shared data access
- **Lock-free data structures** where possible

## Debugging

### Enable Debug Logging

```csharp
// Add to any system
Log.Out($"[RPG Overhaul] Debug: {variable}");
```

### Common Issues

1. **Harmony not loaded** - Ensure 0Harmony.dll is in the game directory
2. **Assembly reference errors** - Verify correct Unity version assemblies
3. **Property not found** - Check XML property names match C# expectations

### Debug Commands (Future Implementation)

- `rpg_debug_stats` - Show current weapon stats with modifiers
- `rpg_debug_mastery` - Display mastery levels
- `rpg_debug_affixes` - List active affixes on held item

## Future Enhancements

### Planned Features

- **Custom UI panels** for weapon modification
- **Network synchronization** for multiplayer
- **Save file integration** for persistent mastery data
- **Advanced synergies** between different part combinations
- **Dynamic loot tables** based on player progression

### Performance Optimizations

- **Batch processing** for multiple effect applications
- **Spatial partitioning** for area-of-effect calculations
- **Shader-based visual effects** for better performance

## Contributing

1. **Follow the existing code style** (consistent with 7D2D conventions)
2. **Add comprehensive comments** for complex logic
3. **Test in both single-player and multiplayer**
4. **Update this documentation** when adding new features

## License

This mod is provided as-is for educational and entertainment purposes. Ensure compliance with 7 Days to Die's modding guidelines and terms of service.
